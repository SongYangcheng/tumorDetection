# 完整数据流程测试指南 ✅

## 🎯 测试目标
验证从数据管理到分析报告的完整流程，确保每个环节都正常工作。

---

## 📋 测试前准备

### 1. 确认系统运行
```bash
# 后端服务
cd backend
python main.py
# 应该看到: Running on http://127.0.0.1:8000

# 前端服务
cd frontend
npm run dev
# 应该看到: Local: http://localhost:5173
```

### 2. 准备测试数据
- 至少一张脑部MRI影像文件
- 支持格式：PNG, JPG, TIFF, DCM, NIfTI (.nii, .nii.gz)
- 推荐尺寸：256x256 或更大

### 3. 登录系统
```
默认管理员账号：
用户名: admin
密码: admin123
```

---

## 🔍 完整流程测试

### 步骤 1️⃣ : 数据管理 - 上传影像

**操作步骤**：
1. 点击侧边栏"数据管理"菜单
2. 点击"上传新病例"按钮
3. 选择或拖拽影像文件
4. 填写患者信息（所有字段都是必填）：
   - 患者ID: `TEST001`
   - 患者姓名: `测试患者`
   - 影像类型: `MRI`（选择下拉框）
   - 扫描日期: 选择今天的日期
   - 备注: `流程测试` (可选)
5. 点击"开始上传"按钮

**预期结果**：
- ✅ 上传进度条显示
- ✅ 上传成功提示
- ✅ 影像出现在列表中
- ✅ 可以看到预览图

**浏览器控制台输出** (按F12查看):
```
✓ 上传成功
```

**故障排查**：
- 如果上传失败，检查后端是否运行
- 检查文件大小（不要超过100MB）
- 确保所有必填字段都已填写

---

### 步骤 2️⃣ : 数据管理 - 选择影像

**操作步骤**：
1. 在数据列表中找到刚上传的影像
2. 点击影像行（整行都可点击）
3. 查看右侧详情面板
4. 验证所有信息正确显示

**预期结果**：
- ✅ 右侧详情面板展开
- ✅ 显示病例ID、患者信息
- ✅ 显示影像预览
- ✅ "开始分析"按钮可用

**可选操作**：
- 点击列表中的"分析"按钮（快捷方式）
- 或点击详情面板的"开始分析"按钮

---

### 步骤 3️⃣ : 跳转到处理与分割

**操作步骤**：
1. 点击"开始分析"按钮

**预期结果**：
- ✅ 页面跳转到 `/workbench?imageId=xxx`
- ✅ URL中包含imageId参数
- ✅ 页面显示"智能分割工作台"标题

**浏览器控制台输出**：
```
🔬 跳转到处理与分割页面，imageId: 123
🔬 WorkbenchView 已加载，imageId: 123
```

**验证点**：
- ✅ 左侧配置面板显示
- ✅ 右侧结果展示区域显示
- ✅ 显示绿色提示框："影像已加载成功"
- ✅ 显示影像ID信息

**故障排查**：
- 如果显示"请从数据管理页面选择影像"，说明imageId未传递
- 检查URL是否包含 `?imageId=xxx`
- 返回数据管理重新选择影像

---

### 步骤 4️⃣ : 配置分割参数

**操作步骤**：
1. 查看左侧配置面板
2. （可选）调整置信度阈值
   - 拖动滑块，默认25%
   - 推荐范围：20%-50%
3. （可选）设置模型权重路径
   - 留空使用服务器默认配置
   - 或输入：`backend/weights/Yolov11_best.pt`

**推荐配置**：
- 置信度阈值：`25%`（默认值）
- 模型权重：留空（使用默认）

**注意事项**：
- 置信度越高，检测越严格，可能漏检
- 置信度越低，检测越宽松，可能误检

---

### 步骤 5️⃣ : 执行分割

**操作步骤**：
1. 确认"开始分割"按钮可用（不是灰色）
2. 点击"开始分割"按钮
3. 等待处理完成（约1-3分钟，取决于图像大小和硬件）

**预期结果**：

**处理中**：
- ✅ 按钮显示"分割中..."和旋转图标
- ✅ 右侧显示加载动画
- ✅ 按钮变为禁用状态

**处理完成**：
- ✅ 右侧显示分割结果图像
- ✅ 下方出现"肿瘤详细信息"面板
- ✅ 显示所有检测指标

**浏览器控制台输出**：
```
正在分析影像...
✅ 分割完成，肿瘤信息已提取: {...}
```

**故障排查**：
- 如果显示"分割失败"，检查：
  - 后端服务是否运行
  - 模型文件是否存在
  - 网络连接是否正常
- 如果一直在"分割中"，可能是：
  - 图像太大（建议<2000x2000）
  - 后端卡住（检查后端日志）
  - 刷新页面重试

---

### 步骤 6️⃣ : 查看肿瘤详细信息

**操作步骤**：
1. 向下滚动查看"肿瘤详细信息"面板
2. 检查所有信息卡片

**应该显示的信息**：

#### 基础信息
- ✅ **检测状态**: 发现肿瘤 / 未发现肿瘤
  - 红色文字 = 发现肿瘤
  - 正常文字 = 未发现

- ✅ **肿瘤实例数**: 数字（如：2）
  - 表示检测到几个独立的肿瘤区域

- ✅ **肿瘤面积占比**: 百分比（如：15.3%）
  - 肿瘤占总影像面积的比例

- ✅ **平均置信度**: 百分比（如：85.6%）
  - AI模型的预测可信度

#### 评估信息
- ✅ **风险等级**: 低风险 / 中风险 / 高风险
  - 🟢 绿色 = 低风险
  - 🟠 橙色 = 中风险
  - 🔴 红色 = 高风险

- ✅ **手术可达性**: 易接近 / 中等 / 困难
  - 根据肿瘤位置评估

- ✅ **肿瘤位置**: 文字描述（如：左侧中部脑组织）

#### 肿瘤实例详情（如果有多个肿瘤）
每个实例显示：
- 实例ID（#1, #2, ...）
- 置信度（87.2%）
- 面积（12,345 px²）
- 边界框坐标

**验证点**：
- ✅ 所有卡片都显示
- ✅ 数据合理（没有NaN或undefined）
- ✅ 颜色编码正确
- ✅ "查看完整报告"按钮可见且可点击

---

### 步骤 7️⃣ : 跳转到分析报告

**操作步骤**：
1. 找到"查看完整报告"按钮
   - 位置：肿瘤详细信息面板右上角
   - 颜色：绿色渐变背景
2. 点击按钮

**预期结果**：
- ✅ 页面跳转到 `/analysis-report?imageId=xxx`
- ✅ URL中包含imageId参数
- ✅ 页面显示"脑肿瘤检测分析报告"标题

**浏览器控制台输出**：
```
📊 跳转到分析报告页面，imageId: 123
📊 AnalysisReportView 加载报告，imageId: 123
📡 正在获取医学影像信息...
✅ 医学影像信息加载成功: {...}
📡 正在获取YOLO检测结果...
✅ YOLO检测结果加载成功: {...}
✅ 报告数据合并完成: {...}
```

**故障排查**：
- 如果显示"加载失败"：
  - 检查URL是否包含imageId
  - 确保先完成了分割步骤
  - 查看控制台错误信息
- 如果显示"未提供影像ID"：
  - 不能直接访问 `/analysis-report`
  - 必须从WorkbenchView跳转

---

### 步骤 8️⃣ : 查看完整分析报告

**操作步骤**：
1. 滚动浏览整个报告
2. 检查每个模块是否正确显示

**应该包含的模块**：

#### 1. 报告头部 ✅
- 标题："脑肿瘤检测分析报告"
- 副标题："基于YOLOv11深度学习模型的智能诊断"
- 导出PDF按钮
- 打印报告按钮

#### 2. 患者信息 ✅
- 患者ID: `TEST001`
- 患者姓名: `测试患者`
- 影像类型: `MRI`
- 扫描日期: 应显示选择的日期
- 上传时间: 自动记录
- 检测时间: 分割时的时间

#### 3. 检测结果总览 ✅
4个卡片并排显示：
- 检测状态
- 肿瘤实例数
- 面积占比
- 平均置信度

#### 4. 影像对比 ✅
- 左侧：原始影像
- 右侧：分割结果（带肿瘤标记）
- 图像清晰，无加载错误

#### 5. 肿瘤详细信息 ✅
- 8项参数详细列表
- 肿瘤实例详情表格
  - 表头：实例ID、置信度、面积、边界框坐标
  - 每行一个实例

#### 6. 风险评估 ✅
- 左侧：风险等级卡片
  - 显示等级（低/中/高）
  - 进度条（宽度对应风险）
  - 详细描述
  
- 右侧：手术可达性卡片
  - 显示可达性（易/中/难）
  - 指示灯动画（颜色对应难度）
  - 详细描述

#### 7. 诊断建议 ✅
- 检测结果描述
- 肿瘤特征分析
- 风险评估说明
- 医疗建议
- 免责声明（红色边框）

#### 8. 报告签名 ✅
- 生成时间
- 系统版本
- 模型信息

**验证所有数据**：
- ✅ 患者信息与上传时一致
- ✅ 检测数据与WorkbenchView一致
- ✅ 图像正确显示
- ✅ 无"N/A"或"undefined"
- ✅ 所有样式正确渲染

---

### 步骤 9️⃣ : 测试导出功能

**操作步骤**：

#### 导出PDF
1. 点击"导出PDF"按钮
2. 浏览器打印对话框弹出
3. 目标选择"保存为PDF"
4. 点击保存

**预期结果**：
- ✅ 打印对话框正常弹出
- ✅ 预览显示完整报告内容
- ✅ 可以保存为PDF文件

#### 打印报告
1. 点击"打印报告"按钮
2. 浏览器打印对话框弹出
3. 选择打印机或取消

**预期结果**：
- ✅ 打印对话框正常弹出
- ✅ 预览显示完整报告内容
- ✅ 可以选择打印或取消

**注意事项**：
- PDF导出使用浏览器原生功能
- 打印样式已优化（隐藏导出按钮等）
- 推荐使用Chrome或Edge浏览器

---

## 🎯 完整流程总结

```
✅ 步骤1: 数据管理 - 上传影像
    ↓ 点击"上传新病例" → 选择文件 → 填写信息 → 上传
    
✅ 步骤2: 数据管理 - 选择影像
    ↓ 点击影像行 → 查看详情
    
✅ 步骤3: 跳转到处理与分割
    ↓ 点击"开始分析"
    
✅ 步骤4: 配置分割参数
    ↓ 调整置信度（可选）
    
✅ 步骤5: 执行分割
    ↓ 点击"开始分割" → 等待完成
    
✅ 步骤6: 查看肿瘤详细信息
    ↓ 检查所有指标
    
✅ 步骤7: 跳转到分析报告
    ↓ 点击"查看完整报告"
    
✅ 步骤8: 查看完整分析报告
    ↓ 滚动浏览所有模块
    
✅ 步骤9: 测试导出功能
    ↓ 导出PDF或打印
```

**总耗时**: 约5-10分钟（包括等待分割时间）

---

## 🐛 常见问题与解决方案

### 问题1: "请从数据管理页面选择影像"
**原因**: 直接访问处理与分割页面，没有imageId参数

**解决**:
1. 返回数据管理页面
2. 重新选择影像
3. 点击"开始分析"

### 问题2: "未提供影像ID"（分析报告页面）
**原因**: 直接访问分析报告页面，没有imageId参数

**解决**:
1. 返回处理与分割页面
2. 确保已完成分割
3. 点击"查看完整报告"

### 问题3: 分割一直在处理中
**可能原因**:
- 图像太大
- 后端卡住
- GPU/CPU资源不足

**解决**:
1. 等待更长时间（最多5分钟）
2. 检查后端日志
3. 刷新页面重试
4. 使用较小的图像

### 问题4: 分析报告显示"YOLO检测结果不存在"
**原因**: 未在处理与分割页面运行分割

**解决**:
1. 返回处理与分割页面
2. 点击"开始分割"
3. 等待完成后再查看报告

### 问题5: 图像无法显示
**可能原因**:
- 图像路径错误
- 后端未正确保存
- CORS问题

**解决**:
1. 检查网络请求（F12 → Network）
2. 确认后端返回正确的图像URL
3. 检查后端 `uploads/` 目录

---

## 📊 验证清单

在测试完成后，使用此清单验证所有功能：

### 数据管理
- [ ] 可以上传影像
- [ ] 可以选择影像
- [ ] 可以查看详情
- [ ] 可以跳转到处理页面
- [ ] imageId正确传递

### 处理与分割
- [ ] imageId正确加载
- [ ] 可以配置参数
- [ ] 可以执行分割
- [ ] 分割结果正确显示
- [ ] 肿瘤详细信息显示完整
- [ ] 可以跳转到分析报告

### 分析报告
- [ ] imageId正确接收
- [ ] 患者信息正确显示
- [ ] 检测结果正确显示
- [ ] 图像对比正常
- [ ] 风险评估正确
- [ ] 诊断建议完整
- [ ] 导出功能正常
- [ ] 打印功能正常

### 控制台日志
- [ ] 无JavaScript错误
- [ ] 所有API调用成功
- [ ] 调试日志清晰明确

---

## 🎉 测试完成

如果所有步骤都通过，恭喜！完整的数据流程已经验证无误。

**下一步**：
- 使用真实的医学影像进行测试
- 测试不同类型的影像格式
- 测试边界情况（非常大/小的图像）
- 进行性能测试

**反馈问题**：
如果发现任何问题，请记录：
1. 问题出现在哪个步骤
2. 浏览器控制台错误信息
3. 后端日志（如有）
4. 复现步骤

---

**文档版本**: v2.0  
**更新日期**: 2026年1月4日  
**测试状态**: ✅ 流程已优化，添加详细调试日志
